<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Linux - SFPi</title>
        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <script src="../js/jquery-1.10.2.min.js" defer></script>
        <script src="../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="..">SFPi</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li >
                                <a href="..">欢迎使用咸鱼派 SFPi</a>
                            </li>
                            <li >
                                <a href="../uboot/">U-Boot</a>
                            </li>
                            <li class="active">
                                <a href="./">Linux</a>
                            </li>
                            <li >
                                <a href="../peripherals/">外设</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li >
                                <a rel="next" href="../uboot/">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li >
                                <a rel="prev" href="../peripherals/">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li>
                                <a href="https://github.com/sbc-fish/sfpi/edit/master/docs/linux.md"><i class="fa fa-github"></i> Edit on GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#linux">Linux 内核编译</a></li>
            <li><a href="#linux-patch">下载 Linux 源码和应用 Patch</a></li>
            <li><a href="#_1">获取交叉编译工具链</a></li>
            <li><a href="#linux-config">生成并更改 Linux .config</a></li>
            <li><a href="#linux_1">编译 Linux 内核</a></li>
            <li><a href="#tf">写入 TF 卡</a></li>
            <li><a href="#rootfs">准备 rootfs</a></li>
            <li><a href="#u-boot">配置 U-Boot 启动选项</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="linux">Linux 内核编译</h1>
<h2 id="linux-patch">下载 Linux 源码和应用 Patch</h2>
<p>我们在 <a href="https://github.com/sbc-fish/sfpi/tree/master/u-boot">sbc-fish/sfpi:/linux</a> 维护了对 Linux 主线内核的 Patch 。它提供了咸鱼派设备的 DTS、默认的 <code>.config</code> 和其它一些小的更改。目前已经支持的内核版本见以上链接，其它内核版本可根据最接近的内核版本的 Patch 进行更改。</p>
<p>下载 Linux 内核源码，以 4.19.1 为例：</p>
<pre><code class="shell">$ wget https://cdn.kernel.org/pub/linux/kernel/v4.x/linux-4.19.1.tar.xz
$ tar xvf linux-4.19.1.tar.xz
$ cd linux-4.19.1
</code></pre>

<p>应用我们提供的 Patch ：</p>
<pre><code class="shell">$ curl https://raw.githubusercontent.com/sbc-fish/sfpi/master/linux/4.19.1/sfpi-linux-4.19.1.patch | patch -p1
patching file arch/arm/boot/dts/Makefile
patching file arch/arm/boot/dts/sun8i-v3s-saltedfishpi.dts
patching file arch/arm/boot/dts/sun8i-v3s.dtsi
patching file arch/arm/configs/saltedfishpi_defconfig
patching file drivers/bluetooth/Kconfig
patching file drivers/bluetooth/hci_h5.c
</code></pre>

<h2 id="_1">获取交叉编译工具链</h2>
<p>您如果已经阅读过 [编译和刷入 U-Boot]（https://sbc-fish.github.io/sfpi/uboot/）中的相关部分，可以跳过这一小节。</p>
<p>您如果是 Archlinux 用户，可以直接安装 <a href="https://www.archlinux.org/packages/community/x86_64/arm-none-eabi-gcc/">arm-none-eabi-gcc</a> ：</p>
<pre><code class="shell">$ sudo pacman -Sy arm-none-eabi-gcc
</code></pre>

<p>您如果是 Debian 用户，可以安装  <a href="https://packages.debian.org/buster/gcc-arm-linux-gnueabihf">gcc-arm-linux-gnueabihf</a> ：</p>
<pre><code class="shell">$ sudo apt install gcc-arm-linux-gnueabihf
</code></pre>

<p>您如果是 Ubuntu 用户，可以安装 <a href="https://packages.ubuntu.com/bionic/gcc-arm-linux-gnueabihf">gcc-arm-linux-gnueabihf</a></p>
<pre><code class="shell">$ sudo apt-get install gcc-arm-linux-gnueabihf
</code></pre>

<p>您如果是 Fedora 用户，可以安装 <a href="https://rpmfind.net/linux/rpm2html/search.php?query=arm-none-eabi-gcc">arm-none-eabi-gcc-cs</a></p>
<pre><code class="shell">$ sudo dnf install arm-none-eabi-gcc-cs
</code></pre>

<p>对于未列出的 Linux 发型版，您可以搜索一下它的源有没有交叉编译工具链，如果没有，也可以使用 <a href="https://releases.linaro.org/components/toolchain/binaries/latest-7/arm-eabi/">Linaro GCC</a>。</p>
<p>由于各发型版安装的交叉编译器前缀不同，如果安装的编译器是 arm-none-eabi-gcc ，那么我们之后用到的 CROSS_COMPILE 就是 arm-none-eabi- ，即去掉最后的 gcc 部分。其它常见的还有 arm-linux-gnueabihf- 和 arm-linux-gnueabi ，都可以。</p>
<h2 id="linux-config">生成并更改 Linux .config</h2>
<h3 id="config">采用我们提供的 .config</h3>
<p>在刚才应用的 Patch 中，已经包含了一个已经测试的 .config ，输入如下命令：</p>
<pre><code class="shell">$ make ARCH=arm CROSS_COMPILE=arm-none-eabi- saltedfishpi_defconfig
</code></pre>

<p>如果想要自己调整配置：</p>
<pre><code class="shell">$ make ARCH=arm CROSS_COMPILE=arm-none-eabi- menuconfig
</code></pre>

<h2 id="linux_1">编译 Linux 内核</h2>
<p>用如下命令编译 Linux 内核：</p>
<pre><code class="shell">$ make ARCH=arm CROSS_COMPILE=arm-none-eabi- -j4
</code></pre>

<p>编译 Linux 的时长取决于您的机器的硬件设施，并根据 CPU 线程数调整 <code>-j</code> 参数。不妨在等待 Linux 编译的时候点杯咖啡。</p>
<p>编译好后，应该可以得到我们想要的 <code>arch/arm/boot/zImage</code> 和 <code>arch/arm/boot/dts/sun8i-v3s-saltedfishpi.dtb</code> 文件。</p>
<h2 id="tf">写入 TF 卡</h2>
<p>将编译得到的 <code>arch/arm/boot/zImage</code> 和 <code>arch/arm/boot/dts/sun8i-v3s-saltedfishpi.dtb</code> 文件拷贝入 TF 卡的文件系统中。建议写入 FAT 或者 EXT 文件系统。</p>
<h2 id="rootfs">准备 rootfs</h2>
<p>仅有内核并不够，我们还需要一个 rootfs 。常见的办法有 buildroot 和直接采用已有的发型版的镜像，这里以 ArchLinuxARM 为例，假设我们预期的 rootfs 分区已经挂载到了 <code>mnt</code> 处：</p>
<pre><code class="shell">$ wget http://os.archlinuxarm.org/os/ArchLinuxARM-armv7-latest.tar.gz
$ bsdtar -xpf ArchLinuxARM-armv7-latest.tar.gz -C mnt
</code></pre>

<p>您如果采用的是 macOS 系统并且无法写入 EXT4 文件系统，可以先找到一台 Linux 机器，进行如下操作：</p>
<pre><code class="shell">$ dd if=/dev/zero of=archlinuxarm.img bs=1M count=1024
$ mkfs.ext4 archlinuxarm.img
$ sudo mount -o loop archlinuxarm.img mnt
$ wget http://os.archlinuxarm.org/os/ArchLinuxARM-armv7-latest.tar.gz
$ bsdtar -xpf ArchLinuxARM-armv7-latest.tar.gz -C mnt
$ sudo umount mnt
</code></pre>

<p>将得到的 <code>archlinuxarm.img</code> 复制到 macOS 系统下，再写入：</p>
<pre><code class="shell">$ sudo dd if=archlinuxarm.img of=/dev/[disk] bs=65535
</code></pre>

<p>此处的 <code>[disk]</code> 可以用 <code>diskutil list</code> 找到相应的分区。为了性能更好，可以在设备名称前添加一个 <code>r</code> ，如 <code>/dev/rdisk4s2</code> 。</p>
<p>如果您在 macOS 上安装了 e2fsprogs （<code>brew install e2fsprogs</code>），可以把文件系统扩大成分区的完整大小：</p>
<pre><code class="shell">$ sudo /usr/local/opt/e2fsprogs/sbin/resize2fs -p /dev/[disk]
</code></pre>

<p>这里的 <code>[disk]</code> 意义同上。</p>
<h2 id="u-boot">配置 U-Boot 启动选项</h2>
<p>在<a href="https://sbc-fish.github.io/sfpi/uboot/">编译和刷入 U-Boot</a>中，您应该已经可以进入到 U-Boot 的界面了。首先需要找到我们刚才构建得到的内核和 <code>.dtb</code> 文件。查看 TF 卡的分区表：</p>
<pre><code class="shell">=&gt; part list mmc 0

Partition Map for MMC device 0  --   Partition Type: DOS

Part    Start Sector    Num Sectors     UUID            Type
  1     8192            85045           68db6199-01     0c
  2     94208           30453760        68db6199-02     83
=&gt;
</code></pre>

<p>此处可以看到 TF 卡上的分区情况。这里的例子是，一个 FAT 分区保存内核和 <code>.dtb</code> 文件，另一个 EXT4 分区存放着 rootfs 。输入以下命令可以确认一下内核存放的地方：</p>
<pre><code class="shell">=&gt; fatls mmc 0:1 # 浏览分区 1 （FAT 文件系统）上的文件
=&gt; ext4ls mmc 0:2 # 浏览分区 2 （EXT4 文件系统）上的文件
</code></pre>

<p>在本教程中，所需的文件 <code>zImage</code> 和 <code>sun8i-v3s-saltedfishpi.dtb</code> 放在了第一个分区（FAT 文件系统）中。输入如下命令把内核和 <code>.dtb</code> 文件加载到内存中：</p>
<pre><code class="shell">=&gt; fatload mmc 0:1 0x41000000 zImage
=&gt; fatload mmc 0:1 0x41800000 sun8i-v3s-saltedfishpi.dtb
</code></pre>

<p>如果是 EXT4 文件系统，可以采用 <code>ext2load</code> 或者 <code>ext4load</code> 代替上面的 <code>fatload</code> 命令。现在开始启动入内核：</p>
<pre><code class="shell">=&gt; setenv bootargs console=ttyS0,115200
=&gt; bootz 0x41000000 - 0x41800000
</code></pre>

<p>此时应该可以看到 Linux 内核成功启动，但因为找不到 rootfs，所以未能完成启动。在上面的例子中，rootfs 位于 TF 卡的第二个分区，于是可以更改启动参数并进入内核：</p>
<pre><code class="shell">=&gt; fatload mmc 0:1 0x41000000 zImage
=&gt; fatload mmc 0:1 0x41800000 sun8i-v3s-saltedfishpi.dtb
=&gt; setenv bootargs console=ttyS0,115200 root=/dev/mmcblk0p2 rw rootwait
=&gt; bootz 0x41000000 - 0x41800000
</code></pre>

<p>需要注意的是，这里的 <code>rootwait</code> 必须要添加，另外 <code>/dev/mmcblk0p2</code> 代表了 TF 卡上的第二个分区，在刚才没有指定 rootfs 的时候，内核会输出如下信息：</p>
<pre><code>[    2.252872] Please append a correct &quot;root=&quot; boot option; here are the available partitions:
[    2.261315] b300        15273984 mmcblk0
[    2.261320]  driver: mmcblk
[    2.268156]   b301           42522 mmcblk0p1 68db6199-01
[    2.268159]
[    2.274971]   b302        15226880 mmcblk0p2 68db6199-02
[    2.274974]
</code></pre>

<p>您可以根据在这里显示出来的信息找到并把 <code>mmcblk0p2</code> 改成相应的 rootfs 。</p>
<p>如果想要保存启动命令，使得之后都可以自动启动，输入以下指令：</p>
<pre><code>=&gt; setenv bootcmd 'fatload mmc 0:1 0x41000000 zImage;fatload mmc 0:1 0x41800000 sun8i-v3s-saltedfishpi.dtb; setenv bootargs console=ttyS0,115200 root=/dev/mmcblk0p2 rw rootwait; bootz 0x41000000 - 0x41800000'
=&gt; saveenv
</code></pre>

<p>此后每次上电之后 U-Boot 就会自动启动进入 Linux 了。也可以手动输入 <code>boot</code> 进入 Linux 。</p></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js" defer></script>
        <script src="../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
